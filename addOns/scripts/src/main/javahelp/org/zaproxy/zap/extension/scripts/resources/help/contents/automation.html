<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<TITLE>Scripts Automation Framework Support</TITLE>
</HEAD>
<BODY>
	<H1>Scripts Automation Framework Support</H1>
	This add-on supports the Automation Framework.

	<H2>Job: script</H2>
    The script job allows you to execute various actions with scripts:
    
	<H2>Action: add</H2>

	Adds the specified script to ZAP. Scripts are enabled but not configured to be loaded when ZAP restarts.
	<p>
	By default the default script engine for the file extension (if any) will be used - this may be overridden using the 'engine' parameter.
	
	<ul>
	<li>type: mandatory, can be any of the script types supported by ZAP
	<li>engine: optional, can be used to override the default engine for the file extension
	<li>name: optional, defaults to the file name, can be used to specify the script in another job
	<li>source: mandatory, the path to the file (absolute or relative to the plan), must be a readable text file
	</ul>
	
	The <code>source</code> parameter was previously called <code>file</code>, both will work.
	
	<H2>Action: remove</H2>

	Removes the specified script from ZAP.
	
	<ul>
	<li>name: mandatory, the name of the script in ZAP
	</ul>

	<H2>Action: run</H2>

	Runs the specified script in ZAP. The script must already be available in ZAP, for example added using the 'add' action.

	<ul>
	<li>type: mandatory, can be 'standalone' or 'targeted'
	<li>name: mandatory for single script run, the name of the script in ZAP (if both 'name' and 'chain' are specified, 'name' is ignored)
	<li>chain: optional for running multiple scripts in sequence, a list of script names (takes precedence over 'name' if both are specified)
	<li>engine: optional, can be used to override the default engine for the file extension
	<li>target: mandatory, if type is 'targeted', the target URL to be invoked for 'targeted' script
	<li>context: optional, the name of the context to use when running the script
	<li>user: optional, the name of the user to use when running the standalone script(s). Currently only supported for Zest scripts, if the context has browser-based or client-script authentication configured, the user will be authenticated before the script executes.
	</ul>

	<H3>Script Chaining</H3>
	<p>
	The run action can execute multiple Zest standalone scripts in sequence using the <code>chain</code> parameter.
	This is useful for workflows that require several scripts to run in order.
	</p>
	<p>
	Chaining requires the Zest add-on to be installed. If it is not loaded or chain preparation fails, the job reports an error and the chain does not run.
	</p>

	<H4>Requirements:</H4>
	<ul>
	  <li>All scripts in the chain must be Zest standalone scripts</li>
	  <li>All scripts must be added via "add" actions in the same plan (or already loaded in ZAP)</li>
	  <li>Script existence and type are validated at runtime, not during plan validation</li>
	  <li>If both <code>chain</code> and <code>name</code> are specified, <code>chain</code> is used and <code>name</code> is ignored (a warning is issued)</li>
	  <li>Only the first script should launch the browser (<code>ZestClientLaunch</code>); subsequent ZestClientLaunch statements are ignored so chains reuse the same browser</li>
	  <li>At the end of the chain, all browser windows opened by the scripts are closed automatically</li>
	</ul>

	<H4>Authentication:</H4>
	<p>
	If <code>user</code> is specified, authentication happens once before the chain runs (during the first script's browser launch).
	The authenticated browser session is shared by all scripts in the chain.
	</p>

	<H4>Error Handling:</H4>
	<p>
	If chain preparation fails (e.g. Zest not loaded) or any script in the chain fails during execution, the job reports an error and stops. Later scripts in the chain are not run.
	</p>

	<H4>Example:</H4>
	<pre>
  - type: script
    parameters:
      action: run
      type: standalone
      chain:
        - access-script
        - navigate-script
        - perform-action-script
      context: mycontext
      user: testuser
	</pre>

	<H2>Action: loaddir</H2>

	Loads all of the scripts in the subdirectories under the specified source path to ZAP. 
	Scripts are enabled but not configured to be loaded when ZAP restarts.
	<p>
	The scripts must be in subdirectories named after the relevant script type (such as ‘active’, ‘passive’, ‘proxy’ etc) 
	and must have an appropriate extension for the script language used.
	
	<ul>
	<li>source: mandatory, the path to the directory (absolute or relative to the plan).
	</ul>
	
	<H2>Action: enable</H2>

	Enables the specified script. The script must already be available in ZAP, for example added using the 'add' action.

	<ul>
		<li>name: mandatory, the name of the script in ZAP
	</ul>

	<H2>Action: disable</H2>

	Disables the specified script. The script must already be available in ZAP, for example added using the 'add' action.

	<ul>
		<li>name: mandatory, the name of the script in ZAP
	</ul>

	<H2>YAML definition</H2>
	Not all of the parameters are valid for all of the actions, see above for details.
	
    <pre>
  - type: script
    parameters:
      action:                    # String: The executed action - available actions: add, remove, run, enable, disable
      type:                      # String: The type of the script
      engine:                    # String: The script engine to use - can be used to override the default engine for the file extension
      name:                      # String: The name of the script, defaults to the file name (for single script run; ignored if 'chain' is specified)
      chain:                     # List: optional; script names to run in sequence (takes precedence over name if both specified)
      source:                    # String: The full or relative file path, must be readable
      inline:                    # String: The full script (may be multi-line) - supply this or 'source' not both
      target:                    # String: The URL to be invoked for "targeted" script type
      context:                   # String: The name of the context to use when running the script (optional)
      user:                      # String: The name of the user to use when running the standalone script (optional, requires context) [Currently only supported for Zest scripts; for chains, authentication happens once before the first script]
	</pre>

	The <code>source</code> parameter was previously called <code>file</code>, both will work.

	<H2>Inline Scripts</H2>
	
	Inline scripts are where the script contents are in the YAML plan rather that a separate file.
	
	An example of adding and running a simple standalone inline script is:

    <pre>
  - type: script
      parameters:
        action: "add"
        type: "standalone"
        engine: "ECMAScript : Graal.js"
        name: "inline-test"
        inline: |
          print("This is a simple example")
          print("Of a multi-line script")
  - type: script
      parameters:
        action: "run"
        type: "standalone"
        name: "inline-test"
	</pre>

	<H2>Interacting with plans</H2>

	Scripts can interact with running plans using code like:
	
	<pre><code>
var extAF = control.getExtensionLoader().getExtension("ExtensionAutomation");

var plans = extAF.getRunningPlans();

if (plans.size() >  0) {
  plans.get(0).getProgress().info("An info message added by a script");
} else {
  print('No running plans');
}
	</code></pre>

</BODY>
</HTML>